<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase ë¡œê·¸ì¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .card {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 800px; /* 800px ì´ìƒìœ¼ë¡œ ë„“ê²Œ */
            text-align: center;
            box-sizing: border-box;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 30px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-google { background-color: #DB4437; color: white; } /* Google ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-api-test { background-color: #ff9800; color: white; } /* API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-secondary-purple { background-color: #673AB7; color: white; } /* ë³´ë¼ìƒ‰ ê³„ì—´ */
        
        dialog {
            border: none;
            border-radius: 15px;
            padding: 2em;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 0 2em rgba(0, 0, 0, 0.2);
            position: relative; /* ì¶”ê°€ */
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        /* #close-login-btn ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #close-login-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        #close-login-btn:hover {
            color: #000;
        }
        .hidden { display: none; }

        /* ì—°ê¸ˆë³µê¶Œ ë²ˆí˜¸ ìŠ¤íƒ€ì¼ */
        .lottery-ball {
            display: flex; /* ìˆ«ì ì¤‘ì•™ ì •ë ¬ */
            justify-content: center;
            align-items: center;
            flex-shrink: 0; /* ê³µê°„ì´ ì¢ì•„ë„ ì°Œê·¸ëŸ¬ì§€ì§€ ì•Šë„ë¡ */
            width: 55px; /* ì •í™•í•œ ì›í˜• */
            height: 55px; /* ì •í™•í•œ ì›í˜• */
            border-radius: 50%;
            background-color: white; /* í°ìƒ‰ ë°°ê²½ */
            color: #000; /* ê²€ì •ìƒ‰ ê¸€ì */
            font-weight: bold;
            font-size: 1.2em; /* í°íŠ¸ í¬ê¸° ì•½ê°„ í‚¤ì›€ */
            margin: 0 3px; /* ì—¬ë°± ì¡°ì • */
            /* box-shadow ì œê±° */
            border: 4px solid transparent; /* 4px ê³ ì • í…Œë‘ë¦¬, ìƒ‰ìƒì€ JSì—ì„œ */
            box-sizing: border-box; /* í…Œë‘ë¦¬ê°€ êµµì–´ë„ ì› í¬ê¸° ìœ ì§€ */
        }
        .lottery-group-ball {
            background-color: white; /* í°ìƒ‰ ë°°ê²½ */
            color: #000; /* ê²€ì •ìƒ‰ ìˆ«ì */
            border-color: #bdc3c7; /* êµµì€ íšŒìƒ‰ í…Œë‘ë¦¬ */
        }
        /* .lottery-number-ball ì€ ì´ì œ getRandomRgbaColor()ì— ì˜í•´ ê°œë³„ì ìœ¼ë¡œ ìŠ¤íƒ€ì¼ë§ë˜ë¯€ë¡œ ì´ í´ë˜ìŠ¤ëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤. */
        .lottery-history-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px dashed #eee;
            display: flex; /* ê³µë“¤ì„ í•œ ì¤„ì— í‘œì‹œí•˜ê¸° ìœ„í•¨ */
            justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            gap: 10px; /* ê³µë“¤ ì‚¬ì´ ê°„ê²© */
            flex-wrap: wrap; /* ë‚´ìš©ì´ ê¸¸ì–´ì§€ë©´ ì¤„ ë°”ê¿ˆ */
        }
        .lottery-group-text {
            font-weight: bold;
            color: #333; /* ê²€ì •ìƒ‰ */
            margin: 0 10px; /* ì–‘ì˜† ì—¬ë°± */
        }
        .lottery-history-title {
            text-align: left;
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #333;
        }
        .lottery-history-container {
            margin-top: 20px;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 10px;
            max-height: 250px; /* ìŠ¤í¬ë¡¤ì„ ìœ„í•´ ë†’ì´ ì œí•œ */
            overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ */
            -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ì—ì„œ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            max-width: 800px; /* ë©”ì¸ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ì— ë§ì¶° í™•ì¥ */
            margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
        }
        #history-container .lottery-ball {
            width: 40px !important;
            height: 40px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 0 !important;
            line-height: 1 !important;
            margin: 0 4px !important;
            font-size: 16px !important;
            font-weight: bold !important;
        }
        .lottery-history-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-bottom: 1px dashed #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ */
            -webkit-overflow-scrolling: touch;
            justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
        }
        .lottery-history-entry strong {
            margin-right: 15px; /* ì‹œê°„ í…ìŠ¤íŠ¸ì™€ ê³µ ì‚¬ì´ ê°„ê²© */
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .history-header #clear-history-btn { /* #clear-history-btnìœ¼ë¡œ ìˆ˜ì • */
            width: auto; /* ë²„íŠ¼ì˜ ë„ˆë¹„ ìë™ ì¡°ì ˆ */
            margin-left: 10px; /* ì œëª©ê³¼ì˜ ê°„ê²© */
            padding: 5px 10px; /* ë²„íŠ¼ íŒ¨ë”© ì¡°ì • */
            font-size: 0.8em; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
        }
    </style>
</head>
<body>
    <div id="auth-section">
        <!-- ì´ˆê¸° ëœë”© í™”ë©´ -->
        <div id="landing-container" class="card">
            <h1>ì—°ê¸ˆë³µê¶Œ ì¶”ì²¨ê¸°</h1>
            <button type="button" id="show-login-dialog-btn" class="btn-primary">ë¡œê·¸ì¸</button>
            <button type="button" id="api-test-btn" class="btn-api-test">ê³µê³µAPI ì—°ìŠµ</button> <!-- API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€ -->
        </div>

        <!-- ë¡œê·¸ì¸ í›„ í™˜ì˜ ë©”ì‹œì§€ -->
        <div id="welcome-container" class="card hidden">
            <h1>í™˜ì˜í•©ë‹ˆë‹¤!</h1>
            <p><span id="user-email"></span>ë‹˜, ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button type="button" id="btn-logout" class="btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
        <dialog id="login-dialog">
        <span id="close-login-btn">&times;</span>
            <h1>ë¡œê·¸ì¸</h1>
            <input type="email" id="login-email" placeholder="ì´ë©”ì¼ (ì•„ì´ë””)" required>
            <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            <button type="button" id="btn-login" class="btn-primary">ë¡œê·¸ì¸</button>
            <button type="button" id="login-google-btn" class="btn-google">Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
            <button type="button" id="open-signup-btn" class="btn-secondary">íšŒì›ê°€ì…</button>
        </dialog>

        <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
        <dialog id="signup-dialog">
            <h1>íšŒì›ê°€ì…</h1>
            <input type="email" id="signup-email" placeholder="ì´ë©”ì¼ (ì•„ì´ë””)" required>
            <input type="password" id="signup-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
            <input type="password" id="signup-password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required>
            <button type="button" id="btn-signup" class="btn-primary">ê°€ì…í•˜ê¸°</button>
            <button type="button" id="google-login-btn" class="btn-google">Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</button> <!-- Google ë¡œê·¸ì¸ ë²„íŠ¼ ì¶”ê°€ -->
            <button type="button" id="close-signup-btn" class="btn-secondary">ë‹«ê¸°</button>
        </dialog>
    </div>

    <div id="game-section" style="display: none;">
        <div class="card">
            <h2>ğŸ’° ì—°ê¸ˆë³µê¶Œ 720+ ì¶”ì²¨ê¸° ğŸ’°</h2>
            <div id="lottery-result" style="margin-top: 20px; font-size: 1.5em; display: flex; justify-content: center; align-items: center; gap: 5px;"></div>
            <button type="button" id="draw-numbers-btn" class="btn-primary" style="margin-top: 20px;">ë²ˆí˜¸ ì¶”ì²¨í•˜ê¸°</button>
            <button type="button" id="draw-5-numbers-btn" class="btn-primary" style="margin-top: 10px;">ìë™ 5 ê²Œì„</button>
            <button type="button" id="game-logout-btn" class="btn-danger" style="margin-top: 10px;">ë¡œê·¸ì•„ì›ƒ</button>
            <div class="history-header">
                <h3 class="lottery-history-title">ğŸ“œ ì¶”ì²¨ ê¸°ë¡</h3> <!-- ì œëª©ì„ ë°–ìœ¼ë¡œ ì´ë™ -->
                <button type="button" id="clear-history-btn" class="btn-danger" style="margin-top: 20px; font-size: 0.8em; padding: 8px;">ê¸°ë¡ ì‚­ì œ</button>
            </div>
            <div id="history-container" class="lottery-history-container">
                <!-- ì¶”ì²¨ ê¸°ë¡ ë‚´ìš©ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </div>
        </div>
    </div>

    <script type="module">
      // Firebase SDK import
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
      import { 
          getAuth, 
          createUserWithEmailAndPassword, 
          signInWithEmailAndPassword,
          onAuthStateChanged,
          signOut,
          GoogleAuthProvider, // GoogleAuthProvider ì¶”ê°€
          signInWithPopup // signInWithPopup ì¶”ê°€
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
      import { 
          getDatabase, 
          ref, 
          set,
          push, // ì¶”ê°€
          onValue, // ì¶”ê°€
          remove // ì¶”ê°€
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

      // Firebase êµ¬ì„± ì •ë³´
      const firebaseConfig = {
        apiKey: "AIzaSyC9Le4nVivvAfkjHsfJdW4cLmxQaPYY1UM",
        authDomain: "t3st1-f1468.firebaseapp.com",
        databaseURL: "https://t3st1-f1468-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "t3st1-f1468",
        storageBucket: "t3st1-f1468.appspot.com",
        messagingSenderId: "890095653625",
        appId: "1:890095653625:web:539b75b67ff3ed68cd0828",
        measurementId: "G-CVCXZCBSTD"
      };

      // Firebase ì•± ë° ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getDatabase(app);

      // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const landingContainer = document.getElementById('landing-container');
      const welcomeContainer = document.getElementById('welcome-container');
      const userEmailSpan = document.getElementById('user-email');
      
      const loginDialog = document.getElementById('login-dialog');
      const signupDialog = document.getElementById('signup-dialog');

      const showLoginDialogBtn = document.getElementById('show-login-dialog-btn');
      const openSignupBtn = document.getElementById('open-signup-btn');
      const closeSignupBtn = document.getElementById('close-signup-btn');
      const closeLoginBtn = document.getElementById('close-login-btn');
      const googleLoginBtn = document.getElementById('google-login-btn');
      const apiTestBtn = document.getElementById('api-test-btn'); // API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ DOM ìš”ì†Œ ì¶”ê°€
      
      const signupBtn = document.getElementById('btn-signup');
      const loginBtn = document.getElementById('btn-login');
      const logoutBtn = document.getElementById('btn-logout');

      const loginGoogleBtn = document.getElementById('login-google-btn'); // ë¡œê·¸ì¸ ëª¨ë‹¬ìš© Google ë²„íŠ¼

      // ìƒˆë¡œ ì¶”ê°€ë  ê²Œì„ ì„¹ì…˜ ê´€ë ¨ DOM ìš”ì†Œ
      const authSection = document.getElementById('auth-section');
      const gameSection = document.getElementById('game-section');
      const lotteryResultDiv = document.getElementById('lottery-result');
      const drawNumbersBtn = document.getElementById('draw-numbers-btn');
      const gameLogoutBtn = document.getElementById('game-logout-btn');
      const draw5NumbersBtn = document.getElementById('draw-5-numbers-btn'); // ìë™ 5ê²Œì„ ë²„íŠ¼
      const clearHistoryBtn = document.getElementById('clear-history-btn'); // ê¸°ë¡ ì‚­ì œ ë²„íŠ¼
      const historyContainer = document.getElementById('history-container'); // ê¸°ë¡ ì»¨í…Œì´ë„ˆ

      // GoogleAuthProvider ì´ˆê¸°í™”
      const googleProvider = new GoogleAuthProvider();

      // ì—°ê¸ˆë³µê¶Œ ë²ˆí˜¸ 1ì„¸íŠ¸ ìƒì„± (ìˆ«ì ë°°ì—´ ë°˜í™˜)
      function generateLotteryNumbersArray() {
          const numbers = [];
          // ì¡°(Group) ì¶”ì²¨ (1~5)
          numbers.push(Math.floor(Math.random() * 5) + 1);
          // 6ìë¦¬ ìˆ«ì ì¶”ì²¨ (0~9)
          for (let i = 0; i < 6; i++) {
              numbers.push(Math.floor(Math.random() * 10));
          }
          return numbers; // [ê·¸ë£¹, ìˆ«ì1, ìˆ«ì2, ìˆ«ì3, ìˆ«ì4, ìˆ«ì5, ìˆ«ì6]
      }

      // ìˆ«ì ë°°ì—´ì„ ë°”íƒ•ìœ¼ë¡œ HTML ìƒì„±
      function createLotteryNumbersHtml(numbersArray) {
          let html = '';
          const borderColors = [
              '#e74c3c', // ë¹¨ê°„ìƒ‰
              '#eb6123', // ì£¼í™©ìƒ‰
              '#f5b813', // ë…¸ë‘ìƒ‰
              '#2c97dd', // íŒŒë‘ìƒ‰
              '#a17dd3', // ë³´ë¼ìƒ‰
              '#9fa1a4'  // íšŒìƒ‰
          ];

          const group = numbersArray[0];
          html += `<span class="lottery-ball lottery-group-ball">${group}</span><span class="lottery-group-text">ì¡°</span>`;

          for (let i = 1; i < numbersArray.length; i++) {
              const number = numbersArray[i];
              const borderColor = borderColors[i - 1]; // ìˆœì„œëŒ€ë¡œ í…Œë‘ë¦¬ ìƒ‰ìƒ ì ìš© (ê·¸ë£¹ ì œì™¸)
              html += `<span class="lottery-ball" style="border-color: ${borderColor};">${number}</span>`;
          }
          return html;
      }


      // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
      
      // ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸°
      showLoginDialogBtn.addEventListener('click', () => loginDialog.showModal());

      // ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
      closeLoginBtn.addEventListener('click', () => loginDialog.close());
      
      // íšŒì›ê°€ì… ëª¨ë‹¬ ì—´ê¸° (ë¡œê·¸ì¸ ëª¨ë‹¬ ë‚´ë¶€ì—ì„œ)
      openSignupBtn.addEventListener('click', () => signupDialog.showModal());
      
      // íšŒì›ê°€ì… ëª¨ë‹¬ ë‹«ê¸°
      closeSignupBtn.addEventListener('click', () => signupDialog.close());








      // ê³µê³µë°ì´í„° API í˜¸ì¶œ ë¡œì§
      apiTestBtn.addEventListener('click', async () => {
          const API_KEY = "0f267767a844a676d882efe37502ce2bcc0ee90ff0070d90e787464f5f1136f5";
          const sidoNameEncoded = encodeURIComponent('ì„œìš¸');
          const originalUrl = "https://apis.data.go.kr/B552584/ArpltnInforInqireSvc/getCtprvnRltmMesureDnsty" +
                      "?serviceKey=" + API_KEY +
                      "&returnType=json" +
                      "&numOfRows=1" +
                      "&pageNo=1" +
                      "&sidoName=" + sidoNameEncoded +
                      "&ver=1.0";
          
          // CORS ìš°íšŒë¥¼ ìœ„í•œ corsproxy.io í”„ë¡ì‹œ ì‚¬ìš©
          const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(originalUrl);

          try {
              const response = await fetch(proxyUrl);
              const textData = await response.text(); // ì¼ë‹¨ í…ìŠ¤íŠ¸ë¡œ ë°›ìŒ
              console.log("ì›ë³¸ ì‘ë‹µ ë°ì´í„°:", textData); // ë””ë²„ê¹…ìš© ì¶œë ¥

              let jsonData;
              try {
                  jsonData = JSON.parse(textData); // JSON íŒŒì‹± ì‹œë„
              } catch (parseError) {
                  alert("ë°ì´í„°ë¥¼ ë°›ì•„ì™”ì§€ë§Œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
                  console.error("íŒŒì‹± ì—ëŸ¬:", parseError);
                  return; // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì—¬ê¸°ì„œ ì¢…ë£Œ
              }
              
              if (jsonData.response && jsonData.response.body && jsonData.response.body.items && jsonData.response.body.items.length > 0) {
                  const pm10Value = jsonData.response.body.items[0].pm10Value;
                  alert("ì„œìš¸ ë¯¸ì„¸ë¨¼ì§€ ë†ë„: " + pm10Value + "ã/ã¥ ì…ë‹ˆë‹¤.");
              } else {
                  alert("ë¯¸ì„¸ë¨¼ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ë°ì´í„° êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.");
              }
          } catch (error) {
              console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", error);
              alert("ì—ëŸ¬ ë°œìƒ: " + error.message);
          }
      });

      // ë¡œê·¸ì¸ ëª¨ë‹¬ìš© Google ë¡œê·¸ì¸ ì²˜ë¦¬
      loginGoogleBtn.addEventListener('click', () => {
          signInWithPopup(auth, googleProvider)
              .then((result) => {
                  // Realtime Databaseì— ì‚¬ìš©ì ì •ë³´ ì €ì¥ (ì„ íƒ ì‚¬í•­, í•„ìš” ì‹œ ì¶”ê°€)
                  // const user = result.user;
                  // set(ref(db, 'users/' + user.uid), { ... });
                  alert('Google ë¡œê·¸ì¸ ì„±ê³µ!');
                  loginDialog.close(); // ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
                  // onAuthStateChangedê°€ í™”ë©´ ì „í™˜ì„ ì²˜ë¦¬í•¨
              })
              .catch((error) => {
                  let errorMessage = "ë¡œê·¸ì¸ ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                  switch (error.code) {
                      case 'auth/popup-closed-by-user':
                          // alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'); // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ì§€ ì•ŠìŒ
                          return; // ì•„ë¬´ê²ƒë„ ì•ˆ í•˜ê³  í•¨ìˆ˜ ì¢…ë£Œ
                      case 'auth/cancelled-popup-request':
                          errorMessage = "íŒì—… ìš”ì²­ì´ ì¶©ëŒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                          break;
                      default:
                          console.error("êµ¬ê¸€ ë¡œê·¸ì¸ ì—ëŸ¬:", error); // ê°œë°œì í™•ì¸ìš©
                          break;
                  }
                  alert(errorMessage);
              });
      });

      // Google ë¡œê·¸ì¸ ì²˜ë¦¬
      googleLoginBtn.addEventListener('click', () => {
          signInWithPopup(auth, googleProvider)
              .then((result) => {
                  const user = result.user;
                  // Realtime Databaseì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                  return set(ref(db, 'users/' + user.uid), {
                      email: user.email,
                      displayName: user.displayName,
                      photoURL: user.photoURL,
                      createdAt: Date.now()
                  }).then(() => {
                      alert('Google ë¡œê·¸ì¸ ì„±ê³µ!');
                      signupDialog.close();
                      authSection.style.display = 'none';
                      gameSection.style.display = 'block';
                      lotteryResultDiv.innerHTML = getLotteryNumbersHtml(); // ë¡œê·¸ì¸ í›„ ë°”ë¡œ ì¶”ì²¨ê¸° ì‹œì‘
                  });
              })
              .catch((error) => {
                  let errorMessage = "ë¡œê·¸ì¸ ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                  switch (error.code) {
                      case 'auth/popup-closed-by-user':
                          // alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'); // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ì§€ ì•ŠìŒ
                          return; // ì•„ë¬´ê²ƒë„ ì•ˆ í•˜ê³  í•¨ìˆ˜ ì¢…ë£Œ
                      case 'auth/cancelled-popup-request':
                          errorMessage = "íŒì—… ìš”ì²­ì´ ì¶©ëŒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                          break;
                      default:
                          console.error("êµ¬ê¸€ ë¡œê·¸ì¸ ì—ëŸ¬:", error); // ê°œë°œì í™•ì¸ìš©
                          break;
                  }
                  alert(errorMessage);
              });
      });

      // íšŒì›ê°€ì… ì²˜ë¦¬
      signupBtn.addEventListener('click', () => {
          const email = document.getElementById('signup-email').value;
          const password = document.getElementById('signup-password').value;
          const confirm = document.getElementById('signup-password-confirm').value;

          if (!email || !password || !confirm) {
              alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return;
          }
          if (password !== confirm) {
              alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return;
          }

          createUserWithEmailAndPassword(auth, email, password)
              .then((userCredential) => {
                  const user = userCredential.user;
                  return set(ref(db, 'users/' + user.uid), {
                      email: user.email,
                      createdAt: Date.now()
                  }).then(() => {
                      alert('íšŒì›ê°€ì… ë° ë°ì´í„° ì €ì¥ ì„±ê³µ!');
                      signupDialog.close();
                  });
              })
              .catch((error) => {
                  let errorMessage = "ì¼ì‹œì ì¸ ì˜¤ë¥˜ë¡œ íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                  switch (error.code) {
                      case 'auth/missing-email':
                          errorMessage = "ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                          break;
                      case 'auth/invalid-email':
                          errorMessage = "ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.";
                          break;
                      case 'auth/email-already-in-use':
                          errorMessage = "ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.";
                          break;
                      case 'auth/weak-password':
                          errorMessage = "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
                          break;
                  }
                  alert(errorMessage);
              });
      });

      // ë¡œê·¸ì¸ ì²˜ë¦¬
      loginBtn.addEventListener('click', () => {
          const email = document.getElementById('login-email').value;
          const password = document.getElementById('login-password').value;
          
          if (!email || !password) {
              alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return;
          }

          signInWithEmailAndPassword(auth, email, password)
              .then((userCredential) => {
                  loginDialog.close(); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
                  alert('ë¡œê·¸ì¸ ì„±ê³µ!'); // ê¸°ì¡´ ì•Œë¦¼ ìœ ì§€
                  authSection.style.display = 'none';
                  gameSection.style.display = 'block';
                  lotteryResultDiv.innerHTML = getLotteryNumbersHtml(); // ë¡œê·¸ì¸ í›„ ë°”ë¡œ ì¶”ì²¨ê¸° ì‹œì‘
              })
              .catch((error) => {
                  alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`);
              });
      });
      
      // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (ë©”ì¸ í™”ë©´ì˜ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼)
      logoutBtn.addEventListener('click', () => {
          signOut(auth).catch((error) => alert(`ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`));
      });

      // ê²Œì„ í™”ë©´ì—ì„œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì²˜ë¦¬
      gameLogoutBtn.addEventListener('click', () => {
          signOut(auth).then(() => {
              alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
              gameSection.style.display = 'none';
              authSection.style.display = 'flex'; // Flexboxë¡œ ì„¤ì •
              // ë¡œê·¸ì¸/íšŒì›ê°€ì… ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
              document.getElementById('login-email').value = '';
              document.getElementById('login-password').value = '';
              document.getElementById('signup-email').value = '';
              document.getElementById('signup-password').value = '';
              document.getElementById('signup-password-confirm').value = '';
              lotteryResultDiv.innerHTML = ''; // ì¶”ì²¨ ê²°ê³¼ ì´ˆê¸°í™”
              historyContainer.innerHTML = ''; // ê¸°ë¡ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
          }).catch((error) => {
              console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error);
              alert(`ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`);
          });
      });

      // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
      onAuthStateChanged(auth, (user) => {
          if (user) {
              authSection.style.display = 'none';
              gameSection.style.display = 'block';
              userEmailSpan.textContent = user.email;

              // ë¡œê·¸ì¸ ì‹œì ì— í•œ ë²ˆ ì¶”ì²¨ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
              lotteryResultDiv.innerHTML = createLotteryNumbersHtml(generateLotteryNumbersArray());

              const userHistoryRef = ref(db, 'users/' + user.uid + '/history');

              // 3. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì‹¤ì‹œê°„ ë™ê¸°í™” (í•µì‹¬)
              onValue(userHistoryRef, (snapshot) => {
                  historyContainer.innerHTML = ''; // ê¸°ë¡ ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸°
                  const historyData = snapshot.val();
                  if (historyData) {
                      // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                      const sortedHistory = Object.values(historyData).sort((a, b) => b.timestamp - a.timestamp);
                      sortedHistory.forEach(entry => {
                          const historyEntryDiv = document.createElement('div');
                          historyEntryDiv.classList.add('lottery-history-entry');
                          const numbersHtml = createLotteryNumbersHtml(entry.numbers);
                          // í•œêµ­ ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                          const date = new Date(entry.timestamp);
                          const formattedTime = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                          historyEntryDiv.innerHTML = `<strong>${formattedTime}</strong>: ${numbersHtml}`;
                          historyContainer.appendChild(historyEntryDiv);
                      });
                  }
              });

              // 2. ë°ì´í„° ì €ì¥ ë¡œì§ (ì¶”ì²¨ ë²„íŠ¼ í´ë¦­ ì‹œ)
              drawNumbersBtn.onclick = () => {
                  const numbersArray = generateLotteryNumbersArray();
                  lotteryResultDiv.innerHTML = createLotteryNumbersHtml(numbersArray); // í˜„ì¬ ì¶”ì²¨ ê²°ê³¼ í‘œì‹œ
                  push(userHistoryRef, { numbers: numbersArray, timestamp: Date.now() });
              };

              // ìë™ 5ê²Œì„ ë²„íŠ¼
              draw5NumbersBtn.onclick = () => {
                  for (let i = 0; i < 5; i++) {
                      const numbersArray = generateLotteryNumbersArray();
                      push(userHistoryRef, { numbers: numbersArray, timestamp: Date.now() });
                  }
              };

              // 4. ê¸°ë¡ ì‚­ì œ ê¸°ëŠ¥ ìˆ˜ì •
              clearHistoryBtn.onclick = () => {
                  if (confirm('ëª¨ë“  ì¶”ì²¨ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                      remove(userHistoryRef);
                  }
              };

          } else {
              authSection.style.display = 'flex'; // ë¡œê·¸ì¸ í™”ë©´ì„ flexë¡œ í‘œì‹œ (ê°€ìš´ë° ì •ë ¬ ìœ„í•¨)
              gameSection.style.display = 'none';
              userEmailSpan.textContent = '';
              lotteryResultDiv.innerHTML = ''; // ì¶”ì²¨ ê²°ê³¼ ì´ˆê¸°í™”
              historyContainer.innerHTML = ''; // ê¸°ë¡ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”

              // ë¡œê·¸ì•„ì›ƒ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
              drawNumbersBtn.onclick = null;
              draw5NumbersBtn.onclick = null;
              clearHistoryBtn.onclick = null;
          }
      });

    </script>
</body>
</html>